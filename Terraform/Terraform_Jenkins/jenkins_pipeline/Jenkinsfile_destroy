pipeline {
    agent any

    tools {
        "org.jenkinsci.plugins.terraform.TerraformInstallation" "terraform"
    }

    environment {
        TF_HOME = tool('terraform')
        TP_LOG = "WARN"
        PATH = "$TF_HOME:$PATH"
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
    }

    stages {
        // stage('Prod preparation'){
        //     steps {
        //         dir('/var/lib/jenkins/workspace/destroy_pipeline/Terraform/Terraform_Jenkins/jenkins_pipeline'){
        //             sh '/usr/bin/terraform init -input=false'
        //         }
        //     }
        // }

        // stage('Plan'){
        //     steps {
        //         dir('/var/lib/jenkins/workspace/destroy_pipeline/Terraform/Terraform_Jenkins/jenkins_pipeline'){
        //             sh "/usr/bin/terraform plan -input=false -out tfplan"
        //             sh '/usr/bin/terraform show -no-color tfplan > tfplan.txt'
        //         }
        //     }
        // }
        // stage('Approval') {
        //     steps {
        //         input('Do you want to apply the plan ??')
        //     }
        // }

        stage ('Destroy') {
            steps {
                dir('Terraform/Terraform_Jenkins/jenkins_pipeline'){
                    sh "/usr/bin/terraform destroy terraform.tfplan -var 'access_key=$AWS_ACCESS_KEY_ID' -var 'secret_key=$AWS_SECRET_ACCESS_KEY' --auto-approve"
                }
            }
        }
    }
}